<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>BEU-BIH Result Printer</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body { background: #f4f6f9; }
        .card { border-radius: 10px; }
        .form-label { font-weight: 600; }
        /* Smooth transition for progress bar */
        .progress-bar { transition: width 0.5s ease; }
    </style>
</head>

<body>

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-7 col-lg-6">

            <div class="card shadow">
                <div class="card-header bg-primary text-white text-center">
                    <h4 class="mb-0">BEU Result Printer</h4>
                </div>

                <div class="card-body">

                    <div id="statusAlert" class="alert" style="display:none;"></div>

                    <form th:action="@{/beu-bih/print}"
                          th:object="${config}"
                          method="post"
                          id="printForm">

                        <div class="mb-3">
                            <label class="form-label">Semester</label>
                            <select class="form-select" th:field="*{semester}">
                                <option value="I">1st Semester</option>
                                <option value="II">2nd Semester</option>
                                <option value="III">3rd Semester</option>
                                <option value="IV">4th Semester</option>
                                <option value="V">5th Semester</option>
                                <option value="VI">6th Semester</option>
                                <option value="VII">7th Semester</option>
                                <option value="VIII">8th Semester</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Examination Year</label>
                            <input type="number" class="form-control" th:field="*{examYear}" placeholder="2024" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Exam Held (Month / Year)</label>
                            <input type="text" class="form-control" th:field="*{examHeld}" placeholder="July/2025" required>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Registration From</label>
                                <input type="number" class="form-control" th:field="*{startReg}" required>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label">Registration To</label>
                                <input type="number" class="form-control" th:field="*{endReg}" required>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Output Folder</label>

                            <input type="file" id="dirPicker" webkitdirectory directory hidden>

                            <div class="input-group">
                                <input type="text"
                                       class="form-control"
                                       th:field="*{outputDir}"
                                       id="outputDir"
                                       placeholder="Default: Downloads/Results"
                                       required>

                                <button type="button" class="btn btn-outline-secondary" onclick="pickDirectory()">
                                    ðŸ“‚ Select Folder
                                </button>
                            </div>
                            <small class="text-muted" style="font-size: 0.8rem;">
                                *If you select a folder, the system will save to <b>Downloads/FolderName</b>.
                            </small>
                        </div>

                        <div class="d-grid mt-4">
                            <button type="submit" id="submitBtn" class="btn btn-success btn-lg">
                                Start Printing PDFs
                            </button>
                        </div>

                    </form>

                    <div class="mt-4" id="progressSection" style="display:none;">
                        <label class="form-label">Status</label>

                        <div class="progress" style="height: 25px;">
                            <div id="progressBar"
                                 class="progress-bar progress-bar-striped progress-bar-animated bg-info"
                                 role="progressbar"
                                 style="width:0%">Initializing...</div>
                        </div>

                        <div class="text-center mt-2 fw-bold text-secondary">
                            <span id="progressText">Initializing...</span>
                        </div>
                    </div>

                </div>
            </div>

        </div>
    </div>
</div>

<script>
    // 1. Directory Picker Logic
    function pickDirectory() {
        const picker = document.getElementById("dirPicker");
        const outputInput = document.getElementById("outputDir");

        picker.click();

        picker.onchange = (e) => {
            if (e.target.files.length > 0) {
                // Browsers block the full path (e.g. D:/), so we get the relative folder name
                const relativePath = e.target.files[0].webkitRelativePath;
                const folderName = relativePath.split("/")[0];

                // Show the folder name in the box
                outputInput.value = folderName;
            }
        };
    }

    // 2. Form Submission & Progress Polling
    const form = document.getElementById("printForm");
    const submitBtn = document.getElementById("submitBtn");
    const progressSection = document.getElementById("progressSection");
    const progressBar = document.getElementById("progressBar");
    const progressText = document.getElementById("progressText");
    const statusAlert = document.getElementById("statusAlert");

    form.addEventListener("submit", async (e) => {
        e.preventDefault(); // Stop page reload

        // Reset UI
        statusAlert.style.display = 'none';
        progressBar.style.width = "5%"; // Show small start progress
        progressBar.textContent = "Starting...";
        progressText.textContent = "Initializing...";

        submitBtn.disabled = true;
        submitBtn.textContent = "Processing...";
        progressSection.style.display = "block";

        // Start polling immediately
        const pollInterval = startPolling();

        try {
            const response = await fetch(form.action, {
                method: 'POST',
                body: new FormData(form)
            });

            if (!response.ok) {
                throw new Error("Server returned error.");
            }

            // Wait for completion (the polling will handle the UI updates)
            // We only stop polling if the server response says so or error occurs

        } catch (error) {
            clearInterval(pollInterval);
            showAlert("danger", "Error: " + error.message);
            submitBtn.disabled = false;
            submitBtn.textContent = "Start Printing PDFs";
        }
    });

    function startPolling() {
        return setInterval(async () => {
            try {
                const res = await fetch("/beu-bih/progress");
                if (res.ok) {
                    const data = await res.json();

                    const total = data.total || 0;
                    const completed = data.completed || 0;
                    const isRunning = data.running;

                    // Calculate Percentage
                    let percent = 0;
                    if (total > 0) {
                        percent = Math.round((completed / total) * 100);
                        progressText.textContent = `${completed} / ${total} Records Processed`;
                    } else {
                        progressText.textContent = "Preparing data...";
                    }

                    // Update Bar
                    progressBar.style.width = (percent < 5 ? 5 : percent) + "%"; // Min 5% width so text is visible
                    progressBar.textContent = percent + "%";

                    // Check if Finished
                    if (!isRunning && total > 0 && completed >= total) {
                        // Success Case
                        progressBar.classList.remove("progress-bar-animated", "bg-info");
                        progressBar.classList.add("bg-success");
                        progressBar.textContent = "Completed";
                        showAlert("success", "Done! Check your Downloads folder.");
                        resetButton();
                        return; // Stop here, the interval will be cleared by the caller or we can clear it:
                        // Ideally we need the interval ID here to clear it inside.
                        // For simplicity, we can just let it run one more time or rely on `isRunning`
                    }
                }
            } catch (err) {
                console.log("Polling error", err);
            }
        }, 1000);
    }

    function resetButton() {
        submitBtn.disabled = false;
        submitBtn.textContent = "Start Printing PDFs";
    }

    function showAlert(type, message) {
        statusAlert.className = `alert alert-${type}`;
        statusAlert.textContent = message;
        statusAlert.style.display = 'block';
    }
</script>

</body>
</html>