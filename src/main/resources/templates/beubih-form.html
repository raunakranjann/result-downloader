<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>BEU-BIH Result Printer</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
          rel="stylesheet">

    <style>
        body {
            background: #f4f6f9;
        }
        .card {
            border-radius: 10px;
        }
        .form-label {
            font-weight: 600;
        }
    </style>
</head>

<body>

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-7 col-lg-6">

            <div class="card shadow">
                <div class="card-header bg-primary text-white text-center">
                    <h4 class="mb-0">BEU-BIH Result Printer</h4>
                </div>

                <div class="card-body">

                    <!-- Success / Error -->
                    <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
                    <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

                    <form th:action="@{/beu-bih/print}"
                          th:object="${config}"
                          method="post"
                          id="printForm">

                        <!-- Semester -->
                        <div class="mb-3">
                            <label class="form-label">Semester</label>
                            <select class="form-select" th:field="*{semester}">
                                <option value="I">1st Semester</option>
                                <option value="II">2nd Semester</option>
                                <option value="III">3rd Semester</option>
                                <option value="IV">4th Semester</option>
                                <option value="V">5th Semester</option>
                                <option value="VI">6th Semester</option>
                                <option value="VII">7th Semester</option>
                                <option value="VIII">8th Semester</option>
                            </select>
                        </div>

                        <!-- Exam Year -->
                        <div class="mb-3">
                            <label class="form-label">Examination Year</label>
                            <input type="number"
                                   class="form-control"
                                   th:field="*{examYear}"
                                   placeholder="2024"
                                   required>
                        </div>

                        <!-- Exam Held -->
                        <div class="mb-3">
                            <label class="form-label">Exam Held (Month / Year)</label>
                            <input type="text"
                                   class="form-control"
                                   th:field="*{examHeld}"
                                   placeholder="July/2025"
                                   required>
                        </div>

                        <!-- Registration Range -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Registration From</label>
                                <input type="number"
                                       class="form-control"
                                       th:field="*{startReg}"
                                       required>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label">Registration To</label>
                                <input type="number"
                                       class="form-control"
                                       th:field="*{endReg}"
                                       required>
                            </div>
                        </div>

                        <!-- Output Folder -->
                        <div class="mb-3">
                            <label class="form-label">Output Folder Name</label>

                            <input type="file"
                                   id="dirPicker"
                                   webkitdirectory
                                   hidden>

                            <div class="input-group">
                                <input type="text"
                                       class="form-control"
                                       th:field="*{outputDir}"
                                       id="outputDir"
                                       placeholder="Select a folder name"
                                       readonly
                                       required>

                                <button type="button"
                                        class="btn btn-outline-secondary"
                                        onclick="pickDirectory()">
                                    Choose Folder
                                </button>
                            </div>

                            <small class="text-muted">
                                PDFs will be saved under server base directory.
                            </small>
                        </div>

                        <!-- Submit -->
                        <div class="d-grid mt-4">
                            <button type="submit"
                                    class="btn btn-success btn-lg">
                                Start Printing PDFs
                            </button>
                        </div>

                    </form>

                    <!-- Progress -->
                    <div class="mt-4" id="progressSection" style="display:none;">
                        <label class="form-label">Progress</label>

                        <div class="progress">
                            <div id="progressBar"
                                 class="progress-bar progress-bar-striped progress-bar-animated"
                                 style="width:0%">0%</div>
                        </div>

                        <div class="text-center mt-2">
                            <span id="progressText">0 / 0</span>
                        </div>
                    </div>

                </div>
            </div>

        </div>
    </div>
</div>

<script>
    function pickDirectory() {
        const picker = document.getElementById("dirPicker");
        picker.click();

        picker.onchange = () => {
            if (picker.files.length > 0) {
                const folder =
                    picker.files[0].webkitRelativePath.split("/")[0];
                document.getElementById("outputDir").value = folder;
            }
        };
    }

    // Progress polling
    const form = document.getElementById("printForm");
    const progressSection = document.getElementById("progressSection");
    const progressBar = document.getElementById("progressBar");
    const progressText = document.getElementById("progressText");

    form.addEventListener("submit", () => {
        progressSection.style.display = "block";
        pollProgress();
    });

    function pollProgress() {
        const interval = setInterval(async () => {
            const res = await fetch("/beu-bih/progress");
            const data = await res.json();

            if (data.total > 0) {
                const percent = Math.round((data.completed / data.total) * 100);
                progressBar.style.width = percent + "%";
                progressBar.textContent = percent + "%";
                progressText.textContent =
                    data.completed + " / " + data.total;
            }

            if (!data.running) {
                clearInterval(interval);
                progressBar.classList.remove("progress-bar-animated");
            }
        }, 1000);
    }
</script>

</body>
</html>
