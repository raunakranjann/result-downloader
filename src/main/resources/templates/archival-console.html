<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Archival Management Console</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

    <style>
        body { background: #f0f2f5; font-family: 'Segoe UI', sans-serif; }

        .console-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .card-header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            border-bottom: 4px solid #3498db;
        }

        .form-label {
            font-size: 0.8rem;
            text-transform: uppercase;
            font-weight: 700;
            color: #636e72;
            letter-spacing: 0.5px;
        }

        /* Console Output Box */
        .console-box {
            background: #2d3436;
            color: #00b894;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85rem;
            margin-bottom: 20px;
            border-left: 4px solid #00b894;
        }

        .progress { height: 8px; background-color: #dfe6e9; border-radius: 4px; margin-top: 15px; }
        .progress-bar { background-color: #00b894; transition: width 0.4s ease; }

        .status-badge {
            font-size: 0.75rem;
            padding: 5px 10px;
            border-radius: 4px;
            background: #636e72;
            color: white;
            font-weight: 600;
        }
        .status-active { background: #e17055; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
    </style>
</head>

<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-5 shadow-sm">
    <div class="container">
        <a class="navbar-brand fw-bold" href="/"><i class="bi bi-shield-lock-fill me-2"></i> Document Archival</a>
        <div class="ms-auto">
            <a href="/" class="btn btn-outline-light btn-sm me-2">Analytics Dashboard</a>
            <a href="/admin/ingestion-portal" class="btn btn-outline-light btn-sm">Ingestion Portal</a>
        </div>
    </div>
</nav>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-9"> <div class="card console-card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="mb-0 fw-bold"><i class="bi bi-printer-fill me-2"></i> BATCH ARCHIVAL JOB</h4>
                    <small class="text-white-50">Automated Queue Management System</small>
                </div>
                <span id="systemBadge" class="status-badge">SYSTEM IDLE</span>
            </div>

            <div class="card-body p-4">

                <div id="statusAlert" class="alert" style="display:none;"></div>

                <form id="archivalForm">

                    <div class="row g-3 mb-3">
                        <div class="col-md-4">
                            <label class="form-label">Semester</label>
                            <select class="form-select" id="semSelect" name="targetSemester">
                                <option value="I">Semester I</option>
                                <option value="II">Semester II</option>
                                <option value="III">Semester III</option>
                                <option value="IV">Semester IV</option>
                                <option value="V" selected>Semester V</option>
                                <option value="VI">Semester VI</option>
                                <option value="VII">Semester VII</option>
                                <option value="VIII">Semester VIII</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Examination Year</label>
                            <input type="number" class="form-control" id="sessionInput" name="academicSession" value="2024" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Exam Held</label>
                            <input type="text" class="form-control" name="publicationCycle" value="July/2025" required>
                        </div>
                    </div>

                    <hr class="text-muted opacity-25">

                    <div class="row g-3 mb-3">
                        <div class="col-md-4">
                            <label class="form-label">Select Batch </label>
                            <select id="yearSelect" class="form-select" onchange="updateConsolePreview()">
                                <option value="21">2021</option>
                                <option value="22" selected>2022</option>
                                <option value="23">2023</option>
                                <option value="24">2024</option>
                                <option value="25">2025</option>
                            </select>
                        </div>
                        <div class="col-md-8">
                            <label class="form-label">Select Branch</label>
                            <select id="branchSelect" class="form-select" onchange="updateConsolePreview()">
                                <option value="All" class="fw-bold text-primary">-- ALL BRANCHES --</option>
                            </select>
                        </div>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-md-12">
                            <label class="form-label">College/Institution</label>
                            <select id="collegeSelect" class="form-select" onchange="updateConsolePreview()">
                                <option value="All" class="fw-bold text-primary">-- ALL COLLEGES --</option>
                            </select>
                        </div>
                    </div>

                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label class="form-label"> Start From</label>
                            <input type="number" class="form-control" id="rollStart" value="1" min="1" max="999" oninput="updateConsolePreview()" required>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">to End</label>
                            <input type="number" class="form-control" id="rollEnd" value="45" min="1" max="999" oninput="updateConsolePreview()" required>
                        </div>
                    </div>

                    <div class="console-box" id="previewText">
                        > System Ready. Waiting for configuration...
                    </div>

                    <div class="d-grid">
                        <button type="submit" id="submitBtn" class="btn btn-primary btn-lg">
                            <i class="bi bi-play-circle me-2"></i> Start
                        </button>
                    </div>

                </form>

                <div class="mt-4 p-3 bg-light rounded border" id="progressSection" style="display:none;">
                    <div class="d-flex justify-content-between align-items-end mb-2">
                        <label class="form-label mb-0" id="batchStatusLabel">Processing Batch 1/1</label>
                        <span id="counterText" class="small fw-bold text-primary">0 / 0</span>
                    </div>

                    <div class="progress">
                        <div id="progressBar" class="progress-bar" role="progressbar" style="width:0%"></div>
                    </div>

                    <p class="text-center mt-2 small text-muted font-monospace" id="logText">Initializing...</p>

                    <div id="downloadButtons" class="row g-2 mt-3" style="display: none;">
                        <div class="col-12 text-center mb-2">
                            <span class="badge bg-success">Task Completed</span>
                        </div>
                        <div class="col-6">
                            <a id="zipBtn" href="#" class="btn btn-dark btn-sm w-100"><i class="bi bi-file-zip me-2"></i> Download ZIP Bundle</a>
                        </div>
                        <div class="col-6">
                            <a id="mergedBtn" href="#" class="btn btn-danger btn-sm w-100"><i class="bi bi-file-pdf me-2"></i> Download Merged PDF</a>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        </div>
    </div>
</div>

<script>
    // ==========================================
    // 1. REGISTRY CONFIGURATION
    // ==========================================
    const branchRegistry = {
        "Civil Engineering (101)": "101",
        "Mechanical Engineering (102)": "102",
        "Electrical Engineering (103)": "103",
        "Electronics & Comm. (104)": "104",
        "Computer Science (105)": "105"
    };

    const collegeRegistry = {
        "Siwan College of Engineering And Management": "123",
        "Government Engineering College Siwan": "151"
    };

    // ==========================================
    // 2. INITIALIZATION & DROPDOWNS
    // ==========================================
    const brSel = document.getElementById('branchSelect');
    const colSel = document.getElementById('collegeSelect');

    for(let [label, code] of Object.entries(branchRegistry)) {
        brSel.add(new Option(label, code));
    }
    brSel.value = "105"; // Default CSE

    for(let [label, code] of Object.entries(collegeRegistry)) {
        colSel.add(new Option(label, code));
    }
    colSel.value = "123"; // Default SCEM

    // ==========================================
    // 3. PREVIEW LOGIC
    // ==========================================
    function updateConsolePreview() {
        const y = document.getElementById('yearSelect').value;
        const b = brSel.value;
        const c = colSel.value;
        const s = document.getElementById('rollStart').value.padStart(3,'0');
        const e = document.getElementById('rollEnd').value.padStart(3,'0');

        let msg = "> TARGET: ";
        if(b === 'All' && c === 'All') msg += "Full Batch Archival (All Branches/Colleges)";
        else if(b === 'All') msg += `All Branches @ Inst Code ${c}`;
        else if(c === 'All') msg += `Branch ${b} @ All Institutions`;
        else msg += `ID Range ${y}${b}${c}${s} - ${y}${b}${c}${e}`;

        document.getElementById('previewText').innerText = msg;
    }
    updateConsolePreview();

    // ==========================================
    // 4. QUEUE MANAGEMENT SYSTEM
    // ==========================================
    let jobQueue = [];
    let totalJobs = 0;
    let jobsCompleted = 0;

    const form = document.getElementById("archivalForm");
    const submitBtn = document.getElementById("submitBtn");
    const progressSection = document.getElementById("progressSection");
    const progressBar = document.getElementById("progressBar");
    const logText = document.getElementById("logText");
    const counterText = document.getElementById("counterText");
    const systemBadge = document.getElementById("systemBadge");

    form.addEventListener("submit", async (e) => {
        e.preventDefault();

        // A. Reset & Build Queue
        jobQueue = [];
        const year = document.getElementById('yearSelect').value;
        const s = document.getElementById('rollStart').value.padStart(3,'0');
        const eRoll = document.getElementById('rollEnd').value.padStart(3,'0');

        const targetCols = (colSel.value === 'All') ? Object.values(collegeRegistry) : [colSel.value];
        const targetBrs = (brSel.value === 'All') ? Object.values(branchRegistry) : [brSel.value];

        targetCols.forEach(cVal => {
            targetBrs.forEach(bVal => {
                jobQueue.push({
                    startReg: `${year}${bVal}${cVal}${s}`,
                    endReg: `${year}${bVal}${cVal}${eRoll}`,
                    desc: `Inst:${cVal} / Br:${bVal}`
                });
            });
        });

        // B. Lock UI
        totalJobs = jobQueue.length;
        jobsCompleted = 0;

        document.getElementById("statusAlert").style.display = 'none';
        document.getElementById("downloadButtons").style.display = 'none';

        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> PROCESSING QUEUE...';
        progressSection.style.display = "block";
        systemBadge.className = "status-badge status-active";
        systemBadge.innerText = "QUEUE ACTIVE";

        // C. Start Processing
        executeNextJob();
    });

    function executeNextJob() {
        if(jobQueue.length === 0) {
            handleQueueCompletion();
            return;
        }

        const task = jobQueue.shift();
        document.getElementById('batchStatusLabel').innerText = `Processing Batch ${jobsCompleted+1}/${totalJobs}: ${task.desc}`;

        // Prepare Payload (Mix of static form data and dynamic queue data)
        const formData = new FormData(form);
        formData.set('rangeStart', task.startReg); // Override start
        formData.set('rangeEnd', task.endReg);     // Override end

        // Initiate Job
        fetch('/admin/archives/api/initiate', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if(data.status === 'JOB_INITIATED') {
                    startTelemetryPoll();
                } else {
                    console.error("Initialization Failed for " + task.desc);
                    jobsCompleted++;
                    executeNextJob(); // Skip and continue
                }
            })
            .catch(err => {
                console.error(err);
                alert('Connection Error');
                submitBtn.disabled = false;
            });
    }

    function startTelemetryPoll() {
        const interval = setInterval(async () => {
            try {
                const res = await fetch("/admin/archives/api/telemetry");
                if (res.ok) {
                    const data = await res.json();

                    const total = data.totalCount;
                    const processed = data.processedCount;
                    const isActive = data.jobActive;
                    const statusMsg = data.operationalStatus;

                    // Update UI
                    let percent = (total > 0) ? Math.round((processed / total) * 100) : 0;
                    progressBar.style.width = percent + "%";
                    logText.innerText = "> " + statusMsg;
                    counterText.innerText = `${processed} / ${total}`;

                    // Check Completion
                    if (!isActive && (processed >= total || total === 0)) {
                        clearInterval(interval);
                        jobsCompleted++;
                        executeNextJob(); // Trigger next in queue
                    }
                }
            } catch (err) {
                console.error("Telemetry Error", err);
            }
        }, 1000);
    }

    function handleQueueCompletion() {
        progressBar.classList.add("bg-success");
        progressBar.style.width = "100%";
        logText.innerText = "> All Archival Jobs Completed Successfully.";
        systemBadge.className = "status-badge bg-success";
        systemBadge.innerText = "COMPLETED";

        // Configure Download Links (Uses the last configured Year/Sem)
        const year = document.getElementById('sessionInput').value;
        const sem = document.getElementById('semSelect').value;

        document.getElementById("zipBtn").href = `/admin/archives/download/zip?year=${year}&semester=${sem}`;
        document.getElementById("mergedBtn").href = `/admin/archives/download/merged?year=${year}&semester=${sem}`;

        document.getElementById("downloadButtons").style.display = "flex";

        // Unlock Button
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="bi bi-play-circle me-2"></i> START NEW BATCH';
    }
</script>

</body>
</html>