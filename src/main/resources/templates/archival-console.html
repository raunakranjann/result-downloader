<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Archival Management Console</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

    <style>
        /* Shared Enterprise Styling */
        body {
            background: #f4f6f9;
            font-family: 'Segoe UI', 'Roboto', sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .main-container {
            margin-top: 50px;
            margin-bottom: 50px;
        }

        .card {
            width: 700px;
            border: none;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            background: white;
        }

        .card-header {
            background-color: #2c3e50;
            color: white;
            border-radius: 8px 8px 0 0 !important;
            padding: 20px;
        }

        .form-label { font-size: 0.8rem; font-weight: 700; text-transform: uppercase; color: #7f8c8d; letter-spacing: 0.5px; }
        .form-select, .form-control { border-radius: 4px; border: 1px solid #ced4da; }
        .form-select:focus, .form-control:focus { border-color: #3498db; box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25); }

        .btn-ingest {
            background-color: #2980b9;
            color: white;
            font-weight: 600;
            padding: 12px;
            width: 100%;
            transition: all 0.3s;
        }
        .btn-ingest:hover { background-color: #2c3e50; }
        .btn-ingest:disabled { background-color: #bdc3c7; }

        .console-box {
            background: #2d3436;
            color: #00b894;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85rem;
            margin-top: 20px;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Progress Bar Section */
        #progress-section { display: none; margin-top: 25px; border-top: 1px solid #ecf0f1; padding-top: 20px; }
        .progress { height: 10px; background-color: #dfe6e9; border-radius: 5px; }
        .progress-bar { background-color: #00b894; transition: width 0.4s ease; }

        .status-badge {
            font-size: 0.7rem;
            padding: 4px 8px;
            border-radius: 4px;
            background: #636e72;
            color: white;
            float: right;
        }
        .status-active { background: #e17055; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
    </style>
</head>

<body>

<nav class="navbar navbar-expand-lg navbar-dark mb-4 shadow-sm w-100" style="background-color: #2c3e50;">
    <div class="container-fluid px-4">
        <a class="navbar-brand fw-bold" href="/"><i class="bi bi-shield-lock-fill me-2"></i>DOCUMENT ARCHIVAL</a>
        <div class="ms-auto">
            <a href="/" class="btn btn-outline-light btn-sm me-2"><i class="bi bi-speedometer2 me-1"></i>Dashboard</a>
            <a href="/admin/links" class="btn btn-outline-light btn-sm"><i class="bi bi-cloud-arrow-down me-1"></i> Configure Urls</a>
        </div>
    </div>
</nav>

<div class="main-container">
    <div class="card">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0 fw-bold"><i class="bi bi-printer-fill me-2"></i> BATCH ARCHIVAL JOB</h5>
                    <small class="text-white-50">Automated Queue Management System</small>
                </div>
                <span id="systemStatus" class="status-badge">SYSTEM IDLE</span>
            </div>
        </div>

        <div class="card-body p-4">

            <div id="statusAlert" class="alert alert-danger" style="display:none;"></div>

            <form id="archivalForm">

                <div class="mb-3">
                    <label class="form-label text-primary">Target Data Source</label>
                    <select id="linkKey" name="linkKey" class="form-select border-primary" required>
                        <option th:each="entry : ${linkMap}" th:value="${entry.key}" th:text="${entry.key}"></option>
                        <option th:if="${linkMap == null || linkMap.isEmpty()}" value="">No Sources Configured</option>
                    </select>
                </div>

                <div class="row g-3 mb-2">
                    <div class="col-4">
                        <label class="form-label">Batch Year</label>
                        <select id="yearSelect" class="form-select" onchange="updateConsolePreview()">
                            <option value="21">2021</option>
                            <option value="22" selected>2022</option>
                            <option value="23">2023</option>
                            <option value="24">2024</option>
                            <option value="25">2025</option>
                        </select>
                    </div>
                    <div class="col-8">
                        <label class="form-label">Engineering Branch</label>
                        <select id="branchSelect" class="form-select" onchange="updateConsolePreview()">
                            <option value="All" class="fw-bold text-primary">-- ALL BRANCHES (QUEUE MODE) --</option>
                        </select>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">College/Institution</label>
                    <select id="collegeSelect" class="form-select" onchange="updateConsolePreview()">
                        <option value="All" class="fw-bold text-primary">-- ALL COLLEGES --</option>
                    </select>
                </div>

                <div class="row g-3">
                    <div class="col-6">
                        <label class="form-label">Start Sequence (ID)</label>
                        <input type="number" id="rollStart" class="form-control" value="1" min="1" max="999" oninput="updateConsolePreview()" required>
                    </div>
                    <div class="col-6">
                        <label class="form-label">End Sequence (ID)</label>
                        <input type="number" id="rollEnd" class="form-control" value="60" min="1" max="999" oninput="updateConsolePreview()" required>
                    </div>
                </div>

                <div class="console-box" id="previewText">
                    > System Ready. Waiting for configuration...
                </div>

                <button type="submit" id="submitBtn" class="btn btn-ingest mt-3">
                    <i class="bi bi-play-circle-fill me-2"></i> INITIATE ARCHIVAL PROCESS
                </button>
            </form>

            <div id="progress-section">
                <div class="d-flex justify-content-between mb-2">
                    <span id="batchStatusLabel" class="small fw-bold text-muted">QUEUE: IDLE</span>
                    <span id="percentText" class="small fw-bold text-primary">0%</span>
                </div>
                <div class="progress">
                    <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                </div>
                <p id="logText" class="text-center text-muted small mt-2 mb-0">Waiting for job delegation...</p>

                <div id="downloadButtons" class="row g-2 mt-3" style="display: none;">
                    <div class="col-12 text-center mb-2">
                        <span class="badge bg-success">Job Cycle Complete</span>
                    </div>
                    <div class="col-6">
                        <a id="zipBtn" href="#" class="btn btn-dark btn-sm w-100"><i class="bi bi-file-zip me-2"></i> Download ZIP</a>
                    </div>
                    <div class="col-6">
                        <a id="mergedBtn" href="#" class="btn btn-danger btn-sm w-100"><i class="bi bi-file-pdf me-2"></i> Download Merged PDF</a>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    // ==========================================
    // 1. REGISTRY CONFIGURATION
    // ==========================================
    const branchRegistry = {
        "Civil Engineering (101)": "101",
        "Mechanical Engineering (102)": "102",
        "Electrical Engineering (103)": "103",
        "Electronics & Comm. (104)": "104",
        "Computer Science (105)": "105"
    };

    const collegeRegistry = {
        "Siwan College of Engineering (123)": "123",
        "Government Engineering College (151)": "151"
    };

    // ==========================================
    // 2. INITIALIZATION
    // ==========================================
    const brSel = document.getElementById('branchSelect');
    const colSel = document.getElementById('collegeSelect');

    for(let [label, code] of Object.entries(branchRegistry)) {
        brSel.add(new Option(label, code));
    }
    brSel.value = "All"; // Default All

    for(let [label, code] of Object.entries(collegeRegistry)) {
        colSel.add(new Option(label, code));
    }
    colSel.value = "123"; // Default SCEM

    // ==========================================
    // 3. PREVIEW LOGIC
    // ==========================================
    function updateConsolePreview() {
        const y = document.getElementById('yearSelect').value;
        const b = brSel.value;
        const c = colSel.value;
        const s = document.getElementById('rollStart').value.padStart(3,'0');
        const e = document.getElementById('rollEnd').value.padStart(3,'0');

        let msg = "> TARGET: ";
        if(b === 'All' && c === 'All') msg += "Full Batch Archival (All Branches/Colleges)";
        else if(b === 'All') msg += `All Branches @ Inst Code ${c}`;
        else if(c === 'All') msg += `Branch ${b} @ All Institutions`;
        else msg += `ID Range ${y}${b}${c}${s} - ${e}`;

        document.getElementById('previewText').innerText = msg;
    }
    updateConsolePreview();

    // ==========================================
    // 4. QUEUE MANAGEMENT SYSTEM
    // ==========================================
    let jobQueue = [];
    let totalJobs = 0;
    let jobsCompleted = 0;

    const form = document.getElementById("archivalForm");
    const submitBtn = document.getElementById("submitBtn");
    const progressSection = document.getElementById("progress-section");
    const progressBar = document.getElementById("progressBar");
    const logText = document.getElementById("logText");
    const percentText = document.getElementById("percentText");
    const systemStatus = document.getElementById("systemStatus");

    form.addEventListener("submit", async (e) => {
        e.preventDefault();

        // A. Reset & Build Queue
        jobQueue = [];
        const year = document.getElementById('yearSelect').value;
        const s = document.getElementById('rollStart').value.padStart(3,'0');
        const eRoll = document.getElementById('rollEnd').value.padStart(3,'0');
        // The LinkKey acts as the configuration for the result (Target Data Source)
        const linkKeyVal = document.getElementById('linkKey').value;

        const targetCols = (colSel.value === 'All') ? Object.values(collegeRegistry) : [colSel.value];
        const targetBrs = (brSel.value === 'All') ? Object.values(branchRegistry) : [brSel.value];

        targetCols.forEach(cVal => {
            targetBrs.forEach(bVal => {
                jobQueue.push({
                    startReg: `${year}${bVal}${cVal}${s}`,
                    endReg: `${year}${bVal}${cVal}${eRoll}`,
                    desc: `Inst:${cVal} / Br:${bVal}`,
                    linkKey: linkKeyVal
                });
            });
        });

        // B. Lock UI
        totalJobs = jobQueue.length;
        jobsCompleted = 0;

        document.getElementById("statusAlert").style.display = 'none';
        document.getElementById("downloadButtons").style.display = 'none';

        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> PROCESSING QUEUE...';
        progressSection.style.display = "block";
        systemStatus.className = "status-badge status-active";
        systemStatus.innerText = "QUEUE ACTIVE";

        // C. Start Processing
        executeNextJob();
    });

    function executeNextJob() {
        if(jobQueue.length === 0) {
            handleQueueCompletion();
            return;
        }

        const task = jobQueue.shift();
        document.getElementById('batchStatusLabel').innerText = `Processing Batch ${jobsCompleted+1}/${totalJobs}: ${task.desc}`;

        // Construct Form Data Payload
        const formData = new FormData();
        formData.set('linkKey', task.linkKey);
        formData.set('rangeStart', task.startReg);
        formData.set('rangeEnd', task.endReg);

        // Initiate Job
        fetch('/admin/archives/api/initiate', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if(data.status === 'JOB_INITIATED') {
                    startTelemetryPoll();
                } else {
                    console.error("Initialization Failed for " + task.desc);
                    jobsCompleted++;
                    executeNextJob(); // Skip and continue
                }
            })
            .catch(err => {
                console.error(err);
                alert('Connection Error');
                submitBtn.disabled = false;
            });
    }

    function startTelemetryPoll() {
        const interval = setInterval(async () => {
            try {
                const res = await fetch("/admin/archives/api/telemetry");
                if (res.ok) {
                    const data = await res.json();

                    const total = data.totalCount;
                    const processed = data.processedCount;
                    const isActive = data.jobActive;
                    const statusMsg = data.operationalStatus;

                    // Update UI
                    let percent = (total > 0) ? Math.round((processed / total) * 100) : 0;
                    progressBar.style.width = percent + "%";
                    logText.innerText = "> " + statusMsg;
                    percentText.innerText = `${processed} / ${total}`;

                    // Check Completion
                    if (!isActive && (processed >= total || total === 0)) {
                        clearInterval(interval);
                        jobsCompleted++;
                        executeNextJob(); // Trigger next in queue
                    }
                }
            } catch (err) {
                console.error("Telemetry Error", err);
            }
        }, 1000);
    }

    function handleQueueCompletion() {
        progressBar.classList.add("bg-success");
        progressBar.style.width = "100%";
        logText.innerText = "> All Archival Jobs Completed Successfully.";
        systemStatus.className = "status-badge bg-success";
        systemStatus.innerText = "COMPLETED";

        // Configure Download Links
        // We use the LinkKey (Target Data Source) as the Batch Name to identify the file
        const batchName = encodeURIComponent(document.getElementById('linkKey').value);

        document.getElementById("zipBtn").href = `/admin/archives/download/zip?batchName=${batchName}`;
        document.getElementById("mergedBtn").href = `/admin/archives/download/merged?batchName=${batchName}`;

        document.getElementById("downloadButtons").style.display = "flex";

        // Unlock Button
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="bi bi-play-circle-fill me-2"></i> START NEW BATCH';
    }
</script>

</body>
</html>