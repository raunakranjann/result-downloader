<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Fetch Data</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; min-height: 100vh; display: flex; align-items: center; justify-content: center; }
        .card { width: 600px; padding: 30px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); border: none; }
        .form-label { font-weight: 600; font-size: 0.9rem; color: #4b5563; }
        .btn-primary { padding: 12px; font-weight: 600; width: 100%; margin-top: 20px; }
        .preview-box { background: #f9fafb; border: 1px dashed #d1d5db; padding: 10px; border-radius: 6px; text-align: center; color: #6b7280; font-family: monospace; font-size: 0.9rem; margin-top: 10px; }

        /* Progress Bar */
        #progress-section { display: none; margin-top: 25px; }
        .progress { height: 20px; border-radius: 10px; background-color: #e5e7eb; }
        .progress-bar { transition: width 0.5s ease; background-color: #10b981; }
        .status-text { text-align: center; font-size: 0.9rem; margin-top: 8px; font-weight: 600; color: #374151; }
        .log-text { text-align: center; font-size: 0.8rem; color: #9ca3af; margin-top: 2px; }
    </style>
</head>
<body>

<div class="card">
    <h3 class="text-center mb-4 fw-bold text-dark">Fetch Student Data</h3>

    <form id="fetchForm">
        <div class="mb-3">
            <label class="form-label">Select Exam Event</label>
            <select id="linkKey" class="form-select" required>
                <option th:each="entry : ${linkMap}" th:value="${entry.key}" th:text="${entry.key}"></option>
                <option th:if="${linkMap == null || linkMap.isEmpty()}" value="B.Tech 7th Sem">B.Tech 7th Sem (Default)</option>
            </select>
        </div>

        <div class="row g-2 mb-2">
            <div class="col-4">
                <label class="form-label">Batch</label>
                <select id="yearSelect" class="form-select" onchange="updatePreview()">
                    <option value="21">2021</option>
                    <option value="22" selected>2022</option>
                    <option value="23">2023</option>
                    <option value="24">2024</option>
                    <option value="25">2025</option>
                    <option value="26">2026</option>
                </select>
            </div>
            <div class="col-8">
                <label class="form-label">Branch</label>
                <select id="branchSelect" class="form-select" onchange="updatePreview()">
                    <option value="All" class="fw-bold text-primary">-- ALL BRANCHES --</option>
                </select>
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label">College</label>
            <select id="collegeSelect" class="form-select" onchange="updatePreview()">
                <option value="All" class="fw-bold text-primary">-- ALL COLLEGES --</option>
            </select>
        </div>

        <div class="row g-2">
            <div class="col-6">
                <label class="form-label">Start Roll</label>
                <input type="number" id="rollStart" class="form-control" value="1" min="1" max="999" oninput="updatePreview()" required>
            </div>
            <div class="col-6">
                <label class="form-label">End Roll</label>
                <input type="number" id="rollEnd" class="form-control" value="60" min="1" max="999" oninput="updatePreview()" required>
            </div>
        </div>

        <div class="preview-box" id="previewText">Initializing...</div>

        <button type="submit" id="submitBtn" class="btn btn-primary">Start Storing</button>
    </form>

    <div id="progress-section">
        <div class="d-flex justify-content-between mb-1">
            <span id="batchStatus" class="small fw-bold">Batch 1/1</span>
            <span id="percentText" class="small fw-bold">0%</span>
        </div>
        <div class="progress">
            <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
        </div>
        <div id="logText" class="log-text">Waiting to start...</div>
    </div>
</div>

<script>
    // 1. CONFIGURATION
    const branches = { "Civil Engineering (101)": "101",
        "Mechanical Engineering (102)": "102",
        "Electrical Engineering (103)": "103",
        "Electronics and Communication Engineering (104)": "104",
        "Computer Science Engineering (105)": "105" };
    const colleges = { "Siwan College Of Engineering And Management (123)": "123",
        "Government Engineering College Siwan (151)": "151" };



    // 2. INIT DROPDOWNS
    const brSel = document.getElementById('branchSelect');
    const colSel = document.getElementById('collegeSelect');

    for(let [k,v] of Object.entries(branches)) {
        let opt = new Option(k, v);
        brSel.add(opt);
    }
    brSel.value = "105"; // Default CSE

    for(let [k,v] of Object.entries(colleges)) {
        let opt = new Option(k, v);
        colSel.add(opt);
    }
    colSel.value = "123"; // Default SCEM

    // 3. PREVIEW LOGIC
    function updatePreview() {
        const y = document.getElementById('yearSelect').value;
        const b = brSel.value;
        const c = colSel.value;
        const s = document.getElementById('rollStart').value.padStart(3,'0');
        const e = document.getElementById('rollEnd').value.padStart(3,'0');

        let msg = "";
        if(b === 'All' && c === 'All') msg = "Queue: ALL Branches in ALL Colleges";
        else if(b === 'All') msg = `Queue: ALL Branches in College ${c}`;
        else if(c === 'All') msg = `Queue: Branch ${b} in ALL Colleges`;
        else msg = `Target: ${y}${b}${c}${s} to ${e}`;

        document.getElementById('previewText').innerText = msg;
    }
    updatePreview();

    // 4. QUEUE SYSTEM
    let taskQueue = [];
    let totalTasks = 0;
    let tasksDone = 0;

    document.getElementById('fetchForm').addEventListener('submit', function(e) {
        e.preventDefault();

        // Build Queue
        taskQueue = [];
        const year = document.getElementById('yearSelect').value;
        const s = document.getElementById('rollStart').value.padStart(3,'0');
        const eRoll = document.getElementById('rollEnd').value.padStart(3,'0');
        const link = document.getElementById('linkKey').value;

        const tCols = (colSel.value === 'All') ? Object.values(colleges) : [colSel.value];
        const tBrs = (brSel.value === 'All') ? Object.values(branches) : [brSel.value];

        tCols.forEach(cVal => {
            tBrs.forEach(bVal => {
                taskQueue.push({
                    linkKey: link,
                    startReg: `${year}${bVal}${cVal}${s}`,
                    endReg: `${year}${bVal}${cVal}${eRoll}`,
                    desc: `Col:${cVal} Br:${bVal}`
                });
            });
        });

        // UI Setup
        totalTasks = taskQueue.length;
        tasksDone = 0;
        document.getElementById('submitBtn').disabled = true;
        document.getElementById('submitBtn').innerText = "Processing...";
        document.getElementById('progress-section').style.display = 'block';

        processQueue();
    });

    function processQueue() {
        if(taskQueue.length === 0) {
            alert("All Batches Completed!");
            location.reload();
            return;
        }

        const task = taskQueue.shift();
        document.getElementById('batchStatus').innerText = `Batch ${tasksDone+1}/${totalTasks}: ${task.desc}`;

        // CALL API
        const formData = new FormData();
        formData.append('linkKey', task.linkKey);
        formData.append('startReg', task.startReg);
        formData.append('endReg', task.endReg);

        fetch('/api/start-batch', { method: 'POST', body: formData })
            .then(res => res.json())
            .then(data => {
                if(data.status === 'started') {
                    pollProgress();
                } else {
                    console.error("Server refused start");
                    tasksDone++;
                    processQueue();
                }
            })
            .catch(err => {
                console.error("API Error", err);
                alert("Connection failed. Check console.");
            });
    }

    function pollProgress() {
        const interval = setInterval(() => {
            fetch('/api/progress')
                .then(res => res.json())
                .then(data => {
                    // Update UI
                    const taskPct = data.total > 0 ? (data.current / data.total) : 0;
                    const totalPct = Math.round(((tasksDone + taskPct) / totalTasks) * 100);

                    document.getElementById('progressBar').style.width = totalPct + "%";
                    document.getElementById('percentText').innerText = totalPct + "%";
                    document.getElementById('logText').innerText = `[${data.current}/${data.total}] ${data.lastLog}`;

                    // Check if done
                    if(!data.running && data.total > 0 && data.current >= data.total) {
                        clearInterval(interval);
                        tasksDone++;
                        processQueue(); // Next Batch
                    }
                })
                .catch(e => clearInterval(interval));
        }, 1000);
    }
</script>

</body>
</html>