<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Student Result Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; padding: 20px; }
        .table-container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); font-size: 0.9rem;}

        /* Table Styling */
        .grade-cell { text-align: center; font-weight: 600; border: 1px solid #dee2e6; vertical-align: middle; }

        /* CELL BACKGROUND COLORS */
        .bg-red { background-color: #ffe6e6 !important; color: #b00000 !important; }
        .bg-yellow { background-color: #fff8d6 !important; color: #856404 !important; }
        .bg-green { background-color: #e6fff2 !important; color: #0f5132 !important; }

        .cgpa-col { font-weight: bold; color: #0d6efd; background-color: #f1f8ff; vertical-align: middle; }
        .search-card { background: #fff; padding: 15px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 20px; }

        /* Truncate long text */
        .text-truncate-cell {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 0; /* Required for flex/table truncation */
        }
    </style>
</head>
<body>

<div class="container-fluid">
    <h2 class="mb-3 text-primary fw-bold"> Student Performance Dashboard</h2>

    <div class="search-card">
        <form action="/dashboard" method="get" class="row g-3 align-items-center">

            <div class="col-md-3">
                <label class="form-label fw-bold small text-muted">Batch Year</label>
                <select name="year" class="form-select">
                    <option value="All">All Batches</option>
                    <option th:each="yr : ${batchYears}"
                            th:value="${yr}"
                            th:text="'20' + ${yr}"
                            th:selected="${yr == selectedYear}"></option>
                </select>
            </div>

            <div class="col-md-4">
                <label class="form-label fw-bold small text-muted">Branch</label>
                <select name="branch" class="form-select">
                    <option value="All">All Branches</option>
                    <option th:each="br : ${branches}"
                            th:value="${br}"
                            th:text="${br}"
                            th:selected="${br == selectedBranch}"></option>
                </select>
            </div>

            <div class="col-md-2 text-center">
                <label class="form-label fw-bold small text-muted d-block">Sort by Rank</label>
                <div class="form-check d-inline-block">
                    <input class="form-check-input" type="checkbox" name="rank" value="true" id="rankCheck" th:checked="${isRanked}">
                    <label class="form-check-label" for="rankCheck">High to Low</label>
                </div>
            </div>

            <div class="col-md-3 d-flex align-items-end">
                <button type="submit" class="btn btn-primary me-2 w-100">Apply Filters</button>
                <a href="/dashboard" class="btn btn-outline-secondary w-50">Reset</a>
            </div>
        </form>
    </div>

    <div class="table-container table-responsive">
        <table class="table table-bordered table-hover align-middle table-sm">
            <thead class="table-dark text-center">
            <tr>
                <th style="width: 3%;">#</th>
                <th style="width: 10%;">Reg No</th>
                <th style="width: 20%; text-align: left;">Name</th>  <th style="width: 25%; text-align: left;">Branch</th> <th style="width: 4%;">S1</th>
                <th style="width: 4%;">S2</th>
                <th style="width: 4%;">S3</th>
                <th style="width: 4%;">S4</th>
                <th style="width: 4%;">S5</th>
                <th style="width: 4%;">S6</th>
                <th style="width: 4%;">S7</th>
                <th style="width: 4%;">S8</th>
                <th class="bg-primary text-white" style="width: 6%;">CGPA</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="student, iterStat : ${students}">
                <td class="text-center fw-bold text-secondary" th:text="${iterStat.count}"></td>

                <td class="text-center fw-bold" th:text="${student.registrationNumber}"></td>

                <td th:text="${student.studentName}" class="fw-semibold text-start"></td>

                <td class="text-start" style="max-width: 250px;">
                    <span class="d-inline-block text-truncate" style="max-width: 100%;"
                          th:title="${student.branch}"
                          th:text="${student.branch}"></span>
                </td>

                <td class="grade-cell" th:with="val=${student.grade?.sem1}, isNum=${val != null and val matches '[0-9.]+'}"
                    th:classappend="${isNum ? (T(java.lang.Double).parseDouble(val) < 5.0 ? 'bg-red' : (T(java.lang.Double).parseDouble(val) <= 7.0 ? 'bg-yellow' : 'bg-green')) : ''}"
                    th:text="${val ?: '-'}"></td>

                <td class="grade-cell" th:with="val=${student.grade?.sem2}, isNum=${val != null and val matches '[0-9.]+'}"
                    th:classappend="${isNum ? (T(java.lang.Double).parseDouble(val) < 5.0 ? 'bg-red' : (T(java.lang.Double).parseDouble(val) <= 7.0 ? 'bg-yellow' : 'bg-green')) : ''}"
                    th:text="${val ?: '-'}"></td>

                <td class="grade-cell" th:with="val=${student.grade?.sem3}, isNum=${val != null and val matches '[0-9.]+'}"
                    th:classappend="${isNum ? (T(java.lang.Double).parseDouble(val) < 5.0 ? 'bg-red' : (T(java.lang.Double).parseDouble(val) <= 7.0 ? 'bg-yellow' : 'bg-green')) : ''}"
                    th:text="${val ?: '-'}"></td>

                <td class="grade-cell" th:with="val=${student.grade?.sem4}, isNum=${val != null and val matches '[0-9.]+'}"
                    th:classappend="${isNum ? (T(java.lang.Double).parseDouble(val) < 5.0 ? 'bg-red' : (T(java.lang.Double).parseDouble(val) <= 7.0 ? 'bg-yellow' : 'bg-green')) : ''}"
                    th:text="${val ?: '-'}"></td>

                <td class="grade-cell" th:with="val=${student.grade?.sem5}, isNum=${val != null and val matches '[0-9.]+'}"
                    th:classappend="${isNum ? (T(java.lang.Double).parseDouble(val) < 5.0 ? 'bg-red' : (T(java.lang.Double).parseDouble(val) <= 7.0 ? 'bg-yellow' : 'bg-green')) : ''}"
                    th:text="${val ?: '-'}"></td>

                <td class="grade-cell" th:with="val=${student.grade?.sem6}, isNum=${val != null and val matches '[0-9.]+'}"
                    th:classappend="${isNum ? (T(java.lang.Double).parseDouble(val) < 5.0 ? 'bg-red' : (T(java.lang.Double).parseDouble(val) <= 7.0 ? 'bg-yellow' : 'bg-green')) : ''}"
                    th:text="${val ?: '-'}"></td>

                <td class="grade-cell" th:with="val=${student.grade?.sem7}, isNum=${val != null and val matches '[0-9.]+'}"
                    th:classappend="${isNum ? (T(java.lang.Double).parseDouble(val) < 5.0 ? 'bg-red' : (T(java.lang.Double).parseDouble(val) <= 7.0 ? 'bg-yellow' : 'bg-green')) : ''}"
                    th:text="${val ?: '-'}"></td>

                <td class="grade-cell" th:with="val=${student.grade?.sem8}, isNum=${val != null and val matches '[0-9.]+'}"
                    th:classappend="${isNum ? (T(java.lang.Double).parseDouble(val) < 5.0 ? 'bg-red' : (T(java.lang.Double).parseDouble(val) <= 7.0 ? 'bg-yellow' : 'bg-green')) : ''}"
                    th:text="${val ?: '-'}"></td>

                <td class="text-center cgpa-col" th:text="${student.grade != null ? student.grade.cgpa : '-'}"></td>
            </tr>
            </tbody>
        </table>
    </div>
</div>

</body>
</html>