<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>BEU-BIH Result Printer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body { background: #f4f6f9; }
        .card { border-radius: 10px; }
        .form-label { font-weight: 600; }
        .progress-bar { transition: width 0.5s ease; }
    </style>
</head>

<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
    <div class="container">
        <a class="navbar-brand fw-bold" href="#">üñ®Ô∏è Result Printer</a>
        <div class="ms-auto">
            <a href="/" class="btn btn-outline-light btn-sm">Analytics Dashboard</a>
            <a href="/fetch-data" class="btn btn-outline-light btn-sm">Fetch Data</a>
            <a href="/show-data" class="btn btn-outline-light btn-sm">Student Records</a>
        </div>
    </div>
</nav>

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-7 col-lg-6">

            <div class="card shadow">
                <div class="card-header bg-primary text-white text-center">
                    <h4 class="mb-0">BEU Result Printer</h4>
                </div>

                <div class="card-body">

                    <div id="statusAlert" class="alert" style="display:none;"></div>

                    <form th:action="@{/Download-results/print}"
                          th:object="${config}"
                          method="post"
                          id="printForm">

                        <div class="mb-3">
                            <label class="form-label">Semester</label>
                            <select class="form-select" th:field="*{semester}" name="semester">
                                <option value="I">1st Semester</option>
                                <option value="II">2nd Semester</option>
                                <option value="III">3rd Semester</option>
                                <option value="IV">4th Semester</option>
                                <option value="V">5th Semester</option>
                                <option value="VI">6th Semester</option>
                                <option value="VII">7th Semester</option>
                                <option value="VIII">8th Semester</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Examination Year</label>
                            <input type="number" class="form-control" th:field="*{examYear}" name="examYear" placeholder="2024" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Exam Held (Month / Year)</label>
                            <input type="text" class="form-control" th:field="*{examHeld}" placeholder="July/2025" required>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Registration From</label>
                                <input type="number" class="form-control" th:field="*{startReg}" required>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label">Registration To</label>
                                <input type="number" class="form-control" th:field="*{endReg}" required>
                            </div>
                        </div>

                        <div class="d-grid mt-4">
                            <button type="submit" id="submitBtn" class="btn btn-success btn-lg">
                                Start Printing PDFs
                            </button>
                        </div>

                    </form>

                    <div class="mt-4" id="progressSection" style="display:none;">
                        <label class="form-label">Status</label>
                        <div class="progress" style="height: 25px;">
                            <div id="progressBar"
                                 class="progress-bar progress-bar-striped progress-bar-animated bg-info"
                                 role="progressbar"
                                 style="width:0%">Initializing...</div>
                        </div>
                        <div class="text-center mt-2 fw-bold text-secondary">
                            <span id="progressText">Initializing...</span>
                        </div>
                    </div>

                </div>
            </div>

        </div>
    </div>
</div>

<script>
    /*
     * DOM Elements Initialization
     */
    const form = document.getElementById("printForm");
    const submitBtn = document.getElementById("submitBtn");
    const progressSection = document.getElementById("progressSection");
    const progressBar = document.getElementById("progressBar");
    const progressText = document.getElementById("progressText");
    const statusAlert = document.getElementById("statusAlert");

    /*
     * Form Submission Handler
     * Intercepts the submit event to perform an asynchronous fetch request.
     * Resets the UI and initiates the progress polling loop.
     */
    form.addEventListener("submit", async (e) => {
        e.preventDefault();

        // Reset UI State
        statusAlert.style.display = 'none';
        progressBar.style.width = "5%";
        progressBar.className = "progress-bar progress-bar-striped progress-bar-animated bg-info";
        progressBar.textContent = "Starting...";
        progressText.textContent = "Initializing...";

        // Clean up previous download buttons
        if(document.getElementById("downloadBtn")) document.getElementById("downloadBtn").remove();
        if(document.getElementById("mergedPdfBtn")) document.getElementById("mergedPdfBtn").remove();

        submitBtn.disabled = true;
        submitBtn.textContent = "Processing...";
        progressSection.style.display = "block";

        const pollInterval = startPolling();

        try {
            const response = await fetch(form.action, {
                method: 'POST',
                body: new FormData(form)
            });

            if (!response.ok) {
                throw new Error("Server returned error.");
            }
        } catch (error) {
            clearInterval(pollInterval);
            showAlert("danger", "Error: " + error.message);
            resetButton();
        }
    });

    /*
     * Polling Logic
     * Periodically checks the '/Download-results/progress' endpoint.
     * Updates the progress bar and triggers completion actions (Success Alert, Download Buttons)
     * when the job finishes.
     */
    function startPolling() {
        return setInterval(async () => {
            try {
                // Fixed Path: Updated to match DownloadResultsController
                const res = await fetch("/Download-results/progress");
                if (res.ok) {
                    const data = await res.json();
                    const total = data.total || 0;
                    const completed = data.completed || 0;
                    const isRunning = data.running;

                    let percent = 0;
                    if (total > 0) {
                        percent = Math.round((completed / total) * 100);
                        progressText.textContent = `${completed} / ${total} Records Processed`;
                    } else {
                        progressText.textContent = "Preparing data...";
                    }

                    progressBar.style.width = (percent < 5 ? 5 : percent) + "%";
                    progressBar.textContent = percent + "%";

                    if (!isRunning && total > 0 && completed >= total) {
                        progressBar.classList.remove("progress-bar-animated", "bg-info");
                        progressBar.classList.add("bg-success");
                        progressBar.textContent = "Completed";

                        showAlert("success", "Done! Files generated on server.");

                        // Show Download Options
                        createDownloadButton();
                        createMergedDownloadButton();

                        resetButton();
                        return;
                    }
                }
            } catch (err) {
                console.log("Polling error", err);
            }
        }, 1000);
    }

    /*
     * Dynamic Button Generators
     * Creates buttons pointing to the '/download-zip' and '/download-merged' endpoints.
     */
    function createDownloadButton() {
        if(document.getElementById("downloadBtn")) return;

        const year = document.querySelector("input[name='examYear']").value;
        const semester = document.querySelector("select[name='semester']").value;

        const btn = document.createElement("a");
        btn.id = "downloadBtn";
        btn.className = "btn btn-primary w-100 mt-3";
        btn.innerHTML = "üì¶ Download All (ZIP)";

        // Fixed Path
        btn.href = `/Download-results/download-zip?year=${year}&semester=${semester}`;
        btn.target = "_blank";

        progressSection.appendChild(btn);
    }

    function createMergedDownloadButton() {
        if(document.getElementById("mergedPdfBtn")) return;

        const year = document.querySelector("input[name='examYear']").value;
        const semester = document.querySelector("select[name='semester']").value;

        const btn = document.createElement("a");
        btn.id = "mergedPdfBtn";
        btn.className = "btn btn-danger w-100 mt-2";
        btn.innerHTML = "üìÑ Download Merged PDF Only";

        // Fixed Path
        btn.href = `/Download-results/download-merged?year=${year}&semester=${semester}`;
        btn.target = "_blank";

        progressSection.appendChild(btn);
    }

    function resetButton() {
        submitBtn.disabled = false;
        submitBtn.textContent = "Start Printing PDFs";
    }

    function showAlert(type, message) {
        statusAlert.className = `alert alert-${type}`;
        statusAlert.textContent = message;
        statusAlert.style.display = 'block';
    }
</script>

</body>
</html>