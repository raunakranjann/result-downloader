#!/bin/bash
set -e

APP_DIR="/opt/academic-analytics"

# 1. Secure Permissions for the Application Folder
# 755 allows everyone to read/execute, but only root to write.
chmod -R 755 "$APP_DIR"

# 2. Set execute permissions for the bundled Linux JRE
chmod +x "$APP_DIR/jre/bin/java"

# 3. Set execute permissions for the bundled Chromium & Sandbox
if [ -d "$APP_DIR/browsers/linux/chrome-linux" ]; then
    echo "Configuring bundled browser permissions..."
    chmod +x "$APP_DIR/browsers/linux/chrome-linux/chrome"
    chmod +x "$APP_DIR/browsers/linux/chrome-linux/chrome-wrapper"
    
    # CRITICAL: The sandbox MUST be owned by root and have 4755 (setuid).
    # This prevents the "SIGTRAP" fatal error and ensures Linux trusts the binary.
    if [ -f "$APP_DIR/browsers/linux/chrome-linux/chrome_sandbox" ]; then
        chown root:root "$APP_DIR/browsers/linux/chrome-linux/chrome_sandbox"
        chmod 4755 "$APP_DIR/browsers/linux/chrome-linux/chrome_sandbox"
    fi
fi

# 4. Set execute permissions for your launch script
chmod +x "$APP_DIR/start_app.sh"

# 5. Force update the desktop database
# This ensures the app appears in the application menu immediately after install.
if [ -f "/usr/share/applications/academic-analytics.desktop" ]; then
    chmod +x /usr/share/applications/academic-analytics.desktop
    update-desktop-database /usr/share/applications || true
fi

# 6. Update Icon Cache
if [ -d "/usr/share/icons/hicolor" ]; then
    gtk-update-icon-cache /usr/share/icons/hicolor || true
fi

echo "Academic Analytics environment configured successfully."
exit 0